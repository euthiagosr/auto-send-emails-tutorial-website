<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatizador de E-mails (Browser)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: A multi-step wizard SPA. This structure is chosen for laypersons to guide them through configuration. Key interactions include Google OAuth login, form-based input for email parameters (recipients, subject, body), attachment ID input, and a manual "send now" trigger. This structure prioritizes user simplicity and direct interaction with Google APIs from the browser. -->
    <!-- Visualization & Content Choices: Report Info -> App steps and email configuration. Goal -> Enable users to configure and trigger email sending directly from the browser. Viz/Presentation -> Interactive wizard steps, form elements, a Google Sign-In button, and dynamic status updates. Interactive Elements -> Form inputs, buttons for navigation, Google login, and manual email sending. Justification -> This approach simplifies the user experience by removing Apps Script code interaction. The manual trigger and sessionStorage highlight the browser-based nature. Removed AI content generation feature as requested. Library/Method -> Vanilla JS for logic, Tailwind CSS for UI/UX, gapi.js for Google API integration. CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        .step-card {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute;
            width: 100%;
            top: 0;
            left: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .visible-step {
            opacity: 1;
            transform: scale(1);
            position: relative;
            pointer-events: auto;
        }
    </style>
</head>
<body class="bg-stone-500 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-2xl overflow-hidden">
            <div id="progress-bar-container" class="p-6 border-b border-stone-200">
                 <h1 class="text-2xl font-bold text-center text-slate-800 mb-2">Automatizador de E-mails (Browser)</h1>
                 <p id="step-title" class="text-center text-slate-500 mb-4">Passo 1 de 5: Boas-vindas</p>
                <div class="bg-stone-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 20%; transition: width 0.5s ease-in-out;"></div>
                </div>
            </div>

            <div class="relative p-6 sm:p-10">
                <!-- Step 1: Welcome -->
                <div id="step-1" class="step-card visible-step">
                    <h2 class="text-3xl font-bold mb-4">Bem-vindo ao seu automatizador de e-mails!</h2>
                    <p class="text-lg text-slate-600 mb-4">Este aplicativo permite que voc√™ configure e envie e-mails diretamente do seu navegador, sem a necessidade de c√≥digo ou Google Apps Script.</p>
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                        <h3 class="font-bold text-blue-800">O que podemos fazer?</h3>
                        <ul class="list-disc list-inside mt-2 text-blue-700">
                            <li>Enviar e-mails para m√∫ltiplos destinat√°rios.</li>
                            <li>Anexar m√∫ltiplos arquivos do seu Google Drive.</li>
                            <li>Tudo isso com uma interface simples!</li>
                        </ul>
                    </div>
                </div>

                <!-- Step 2: Google Login -->
                <div id="step-2" class="step-card hidden-step">
                    <h2 class="text-3xl font-bold mb-4">Conecte sua Conta Google</h2>
                    <p class="text-lg text-slate-600 mb-6">Para que o aplicativo possa enviar e-mails e acessar seus arquivos do Google Drive, voc√™ precisa autoriz√°-lo com sua conta Google.</p>
                    <div class="flex justify-center items-center h-48 bg-stone-100 rounded-lg shadow-inner">
                        <button id="authorize_button" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-md hover:bg-blue-700 transition duration-300 flex items-center justify-center text-lg">
                            <svg class="w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor"><path d="M488 261.8C488 408.8 379.2 512 256 512c-69.6 0-136.3-31.5-179.9-86.4L105.5 352h-95v96h-16v-96h-16v-16h16v-96h16v16h95.9C159.7 448.5 208.4 480 256 480c103.5 0 188.7-88.7 188.7-188.7S359.5 102.7 256 102.7c-47.6 0-94.3 20.2-127.3 54.7l-7.5-6.8-67-67c37-33.8 86.8-54.7 139.8-54.7C379.2 32 488 141.2 488 261.8z"/></svg>
                            Conectar com Google
                        </button>
                        <p id="auth_status" class="hidden text-green-700 font-semibold">Conectado!</p>
                    </div>
                    <p class="text-sm text-slate-500 mt-4 text-center">Ser√° aberta uma janela para voc√™ fazer login e dar as permiss√µes necess√°rias. √â seguro, pois voc√™ est√° se conectando diretamente aos servi√ßos do Google.</p>
                </div>

                <!-- Step 3: Configure Email -->
                <div id="step-3" class="step-card hidden-step">
                    <h2 class="text-3xl font-bold mb-4">Configurar Automa√ß√£o de E-mails</h2>
                    <p class="text-lg text-slate-600 mb-6">Preencha os detalhes do e-mail que voc√™ deseja automatizar.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="recipient" class="font-semibold text-slate-700">E-mail(s) do(s) Destinat√°rio(s) <br><span class="font-normal text-sm text-slate-500">(separar por v√≠rgula, ex: email1@ex.com, email2@ex.com)</span></label>
                            <input type="text" id="recipient" placeholder="paraquem@email.com" class="w-full mt-1 p-2 border border-stone-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label for="subject" class="font-semibold text-slate-700">Assunto do E-mail</label>
                            <input type="text" id="subject" value="Relat√≥rio Di√°rio" class="w-full mt-1 p-2 border border-stone-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label for="body" class="font-semibold text-slate-700">Conte√∫do do E-mail</label>
                            <textarea id="body" rows="6" class="w-full mt-1 p-2 border border-stone-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none">Ol√°! Este √© o seu relat√≥rio di√°rio. Tenha um √≥timo dia!</textarea>
                            </div>
                        <div>
                            <label for="attachment_ids" class="font-semibold text-slate-700">IDs dos Anexos do Google Drive <br><span class="font-normal text-sm text-slate-500">(Opcional, separar por v√≠rgula, ex: ID1,ID2)</span></label>
                            <textarea id="attachment_ids" rows="2" placeholder="ID do arquivo do Google Drive" class="w-full mt-1 p-2 border border-stone-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                            <p class="text-xs text-slate-500 mt-1">Para obter o ID, abra o arquivo no Google Drive e copie a parte da URL entre "/d/" e "/view".</p>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Send Drafts Manually -->
                <div id="step-4" class="step-card hidden-step">
                    <h2 class="text-3xl font-bold mb-4">Gerar e Enviar Rascunhos</h2>
                    <p class="text-lg text-slate-600 mb-6">Com as configura√ß√µes prontas, voc√™ pode gerar rascunhos e envi√°-los manualmente. Lembre-se, este app n√£o envia e-mails automaticamente em segundo plano quando a aba √© fechada.</p>
                    <div class="bg-stone-100 p-6 rounded-lg shadow-inner text-center">
                        <div class="mb-6">
                            <label for="num_drafts_to_create_send" class="font-semibold text-slate-700 block mb-2">Quantos rascunhos quer criar/enviar AGORA?</label>
                            <input type="number" id="num_drafts_to_create_send" value="1" min="1" class="w-24 p-2 border border-stone-300 rounded-md text-center focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <button id="create_and_send_button" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-md hover:bg-blue-700 transition duration-300 flex items-center justify-center mx-auto disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="send-spinner" class="hidden animate-spin h-5 w-5 border-4 border-white border-t-transparent rounded-full mr-2"></span>
                            Criar e Enviar Agora
                        </button>
                        <p id="send_status" class="mt-4 text-lg font-semibold text-slate-700"></p>
                    </div>
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg mt-6">
                        <h3 class="font-bold text-yellow-800">Aten√ß√£o!</h3>
                        <p class="text-yellow-700">Este aplicativo √© executado no seu navegador. Ele **n√£o far√° envios di√°rios autom√°ticos se a aba ou o navegador for fechado**. A funcionalidade "di√°ria" no Apps Script √© substitu√≠da por um envio manual aqui.</p>
                    </div>
                </div>

                <!-- Step 5: Done -->
                <div id="step-5" class="step-card hidden-step">
                    <h2 class="text-3xl font-bold text-green-600 mb-4">Tudo pronto! üéâ</h2>
                    <p class="text-lg text-slate-600 mb-6">Seus e-mails foram processados. Lembre-se das limita√ß√µes do envio via navegador.</p>
                    <div class="bg-stone-100 p-6 rounded-lg shadow-inner">
                        <p class="font-semibold mb-2">Para enviar mais e-mails:</p>
                        <ul class="list-disc list-inside mt-2 text-slate-700">
                           <li>Basta voltar ao Passo 4 e clicar em "Criar e Enviar Agora" novamente.</li>
                           <li>Suas configura√ß√µes s√£o salvas automaticamente enquanto a aba est√° aberta.</li>
                        </ul>
                    </div>
                    <button id="reset_app_button" class="mt-6 bg-red-600 text-white font-bold py-2 px-6 rounded-md hover:bg-red-700 transition duration-300 mx-auto block">
                        Recome√ßar
                    </button>
                </div>
            </div>
            
            <div id="navigation-buttons" class="p-6 border-t border-stone-200 flex justify-between items-center">
                <button id="prev-button" class="bg-stone-200 text-slate-700 font-bold py-2 px-6 rounded-md hover:bg-stone-300 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">Anterior</button>
                <button id="next-button" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-md hover:bg-blue-700 transition duration-300">Pr√≥ximo</button>
            </div>
        </div>
    </div>


<script>
    // IMPORTANTE: SUBSTITUA 'SEU_CLIENT_ID_AQUI' pelo seu ID de Cliente real do Google Cloud.
    // Voc√™ o obt√©m em Google Cloud Console > APIs e Servi√ßos > Credenciais.
    // Certifique-se tamb√©m de que as "URIs de JavaScript autorizadas" na configura√ß√£o do CLIENT_ID
    // incluem o endere√ßo de onde voc√™ est√° a executar este arquivo HTML (ex: http://localhost:8000 ou https://canvas.google.com).
    const CLIENT_ID = '435236677809-ndh53a8ounc6a7e29gjaki2ki16c192o.apps.googleusercontent.com'; 
    
    // A API_KEY √© menos comum para este tipo de autentica√ß√£o (OAuth), mas pode ser necess√°ria para algumas APIs.
    // No ambiente Canvas, ela pode ser injetada automaticamente. Fora, voc√™ pode obt√™-la no Google Cloud Console.
    const API_KEY = ''; // Deixei vazia, esperando que o Canvas a injete ou que voc√™ a adicione se estiver fora do Canvas.

    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest", "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const SCOPES = 'https://www.googleapis.com/auth/gmail.compose https://www.googleapis.com/auth/drive.readonly';

    const steps = [
        { id: 1, title: "Passo 1 de 5: Boas-vindas" },
        { id: 2, title: "Passo 2 de 5: Conecte-se com o Google" },
        { id: 3, title: "Passo 3 de 5: Configurar Automa√ß√£o" },
        { id: 4, title: "Passo 4 de 5: Gerar e Enviar" },
        { id: 5, title: "Passo 5 de 5: Conclu√≠do!" },
    ];
    let currentStep = 0;
    let auth2; // GoogleAuth object

    const prevButton = document.getElementById('prev-button');
    const nextButton = document.getElementById('next-button');
    const progressBar = document.getElementById('progress-bar');
    const stepTitle = document.getElementById('step-title');

    const authorizeButton = document.getElementById('authorize_button');
    const authStatus = document.getElementById('auth_status');
    const recipientInput = document.getElementById('recipient');
    const subjectInput = document.getElementById('subject');
    const bodyInput = document.getElementById('body');
    const attachmentIdsInput = document.getElementById('attachment_ids');
    const numDraftsToCreateSendInput = document.getElementById('num_drafts_to_create_send');
    const createAndSendButton = document.getElementById('create_and_send_button');
    const sendStatus = document.getElementById('send_status');
    const resetAppButton = document.getElementById('reset_app_button');


    // Helper to base64url encode a string
    function base64urlEncode(str) {
        return btoa(unescape(encodeURIComponent(str))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    // Helper to construct MIME email for Gmail API
    function createEmail(to, subject, message, attachments) {
        let str = [
            'Content-Type: multipart/mixed; boundary="foo_bar_baz"\r\n',
            'MIME-Version: 1.0\r\n',
            `To: ${to}\r\n`,
            `Subject: =?utf-8?B?${base64urlEncode(subject)}?=\r\n`,
            '\r\n',
            '--foo_bar_baz\r\n',
            'Content-Type: text/plain; charset="UTF-8"\r\n',
            'MIME-Version: 1.0\r\n',
            'Content-Transfer-Encoding: 7bit\r\n',
            '\r\n',
            `${message}\r\n`,
            '\r\n'
        ].join('');

        attachments.forEach(attachment => {
            str += `--foo_bar_baz\r\n`;
            str += `Content-Type: ${attachment.mimeType}\r\n`;
            str += `MIME-Version: 1.0\r\n`;
            str += `Content-Transfer-Encoding: base64\r\n`;
            str += `Content-Disposition: attachment; filename="${attachment.filename}"\r\n`;
            str += '\r\n';
            str += `${attachment.data}\r\n`;
            str += '\r\n';
        });

        str += '--foo_bar_baz--';
        return str;
    }

    // Google API Initialization
    function handleClientLoad() {
        gapi.load('client:auth2', initClient);
    }

    async function initClient() {
        console.log("Iniciando gapi.client.init...");
        try {
            const initConfig = {
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            };
            // Conditionally add apiKey if it's provided and not empty
            if (API_KEY) {
                initConfig.apiKey = API_KEY;
            }

            await gapi.client.init(initConfig);
            console.log("gapi.client.init conclu√≠do.");
            auth2 = gapi.auth2.getAuthInstance();
            auth2.isSignedIn.listen(updateSigninStatus);
            updateSigninStatus(auth2.isSignedIn.get());
        } catch (error) {
            console.error("Erro ao inicializar gapi.client:", error);
            let errorMessage = "Erro ao carregar a API do Google. ";
            if (error.details && error.details.includes("idpiframe_initialization_failed")) {
                errorMessage += "Isso geralmente indica que o CLIENT_ID ou as URIs de JavaScript autorizadas est√£o incorretos no Google Cloud Console. Por favor, verifique-os cuidadosamente.";
            } else if (error.result && error.result.error && error.result.error.message && error.result.error.message.includes("API discovery response missing required fields")) {
                 errorMessage += "A resposta de descoberta da API est√° faltando campos obrigat√≥rios. Isso pode significar que as APIs do Gmail e/ou Google Drive n√£o est√£o ativadas para o seu projeto no Google Cloud Console. Por favor, ative-as.";
            } else if (error.message && error.message.includes("Invalid cookiePolicy")) {
                 errorMessage += "Pol√≠tica de cookies inv√°lida. Certifique-se de que as URIs de JavaScript autorizadas no Google Cloud Console correspondem exatamente ao dom√≠nio onde o app est√° a ser executado e que cookies de terceiros n√£o est√£o bloqueados no seu navegador.";
            }
            else {
                errorMessage += "Verifique o console do navegador para detalhes e certifique-se de que o CLIENT_ID e as URIs autorizadas est√£o corretos no Google Cloud Console.";
            }
            alert(errorMessage);
        }
    }

    function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
            authorizeButton.classList.add('hidden');
            authStatus.classList.remove('hidden');
            if (currentStep === 1) { 
                nextButton.disabled = false;
            }
        } else {
            authorizeButton.classList.remove('hidden');
            authStatus.classList.add('hidden');
            if (currentStep === 1) { 
                nextButton.disabled = true;
            }
        }
    }

    async function handleAuthClick() {
        console.log("Bot√£o 'Conectar com Google' clicado.");
        if (auth2 && auth2.isSignedIn.get()) { // Adicionada verifica√ß√£o para auth2 n√£o ser undefined
            console.log("J√° est√° conectado.");
        } else {
            try {
                // Verifique se auth2 foi inicializado antes de chamar signIn
                if (!auth2) {
                    console.error("auth2 n√£o foi inicializado. Tentando inicializar novamente.");
                    await initClient(); // Tenta inicializar novamente
                    if (!auth2) { // Se ainda for undefined, n√£o podemos continuar
                        alert("N√£o foi poss√≠vel inicializar o servi√ßo de autentica√ß√£o do Google. Verifique o console para detalhes.");
                        return;
                    }
                }
                await auth2.signIn();
                console.log("Login iniciado.");
            } catch (error) {
                console.error("Erro de autentica√ß√£o ao tentar fazer login:", error);
                if (error.details && error.details.includes("popup_closed_by_user")) {
                     alert("A janela pop-up de login foi fechada. Por favor, tente novamente e n√£o feche a janela.");
                } else if (error.error === "idpiframe_initialization_failed") {
                    alert("Erro de inicializa√ß√£o do login. Verifique se o CLIENT_ID e as URIs de JavaScript autorizadas est√£o corretos no Google Cloud Console.");
                } else {
                     alert("Falha na autentica√ß√£o. Verifique o console do navegador para mais detalhes e suas permiss√µes.");
                }
            }
        }
    }

    // App Logic and UI Control
    function showStep(index) {
        steps.forEach((step, i) => {
            const stepElement = document.getElementById(`step-${step.id}`);
            if (stepElement) { 
                if (i === index) {
                    stepElement.classList.remove('hidden-step');
                    stepElement.classList.add('visible-step');
                } else {
                    stepElement.classList.add('hidden-step');
                    stepElement.classList.remove('visible-step');
                }
            }
        });

        const progress = ((index + 1) / steps.length) * 100;
        progressBar.style.width = `${progress}%`;
        stepTitle.textContent = steps[index].title;
        
        prevButton.disabled = index === 0;
        
        if(index === steps.length - 1) {
            nextButton.textContent = 'Voltar ao In√≠cio';
        } else {
            nextButton.textContent = 'Pr√≥ximo';
        }

        if (index === 1) { // Google Login step
            if (auth2 && auth2.isSignedIn.get()) { // Verifica√ß√£o para auth2
                nextButton.disabled = false;
            } else {
                nextButton.disabled = true;
            }
        } else {
            nextButton.disabled = false; 
        }

        if (index === 4) { // Done step - hide navigation
            document.getElementById('navigation-buttons').classList.add('hidden');
        } else {
            document.getElementById('navigation-buttons').classList.remove('hidden');
        }

        loadConfig(); 
    }

    function saveConfig() {
        const config = {
            recipient: recipientInput.value,
            subject: subjectInput.value,
            body: bodyInput.value,
            attachmentIds: attachmentIdsInput.value
        };
        sessionStorage.setItem('emailConfig', JSON.stringify(config));
    }

    function loadConfig() {
        const savedConfig = sessionStorage.getItem('emailConfig');
        if (savedConfig) {
            const config = JSON.parse(savedConfig);
            recipientInput.value = config.recipient || '';
            subjectInput.value = config.subject || 'Relat√≥rio Di√°rio';
            bodyInput.value = config.body || 'Ol√°! Este √© o seu relat√≥rio di√°rio. Tenha um √≥timo dia!';
            attachmentIdsInput.value = config.attachmentIds || '';
        }
    }

    // Email Sending Logic
    async function createAndSendEmails() {
        sendSpinner.classList.remove('hidden');
        createAndSendButton.disabled = true;
        sendStatus.textContent = 'Processando...';

        const recipients = recipientInput.value.split(',').map(e => e.trim()).filter(e => e);
        const subject = subjectInput.value;
        const body = bodyInput.value;
        const attachmentIds = attachmentIdsInput.value.split(',').map(id => id.trim()).filter(id => id);
        const numToProcess = parseInt(numDraftsToCreateSendInput.value);

        if (recipients.length === 0) {
            sendStatus.textContent = 'Erro: Por favor, insira pelo menos um destinat√°rio.';
            sendSpinner.classList.add('hidden');
            createAndSendButton.disabled = false;
            return;
        }
        if (!subject || !body) {
            sendStatus.textContent = 'Erro: Assunto e Conte√∫do do E-mail n√£o podem estar vazios.';
            sendSpinner.classList.add('hidden');
            createAndSendButton.disabled = false;
            return;
        }
        
        // Ensure auth2 is initialized before proceeding with API calls
        if (!auth2 || !auth2.isSignedIn.get()) {
            sendStatus.textContent = 'Erro: Voc√™ n√£o est√° conectado com sua conta Google. Por favor, conecte-se no Passo 2.';
            sendSpinner.classList.add('hidden');
            createAndSendButton.disabled = false;
            return;
        }


        let attachmentsBlobs = [];
        for (const id of attachmentIds) {
            try {
                const fileMetadata = await gapi.client.drive.files.get({
                    fileId: id,
                    fields: 'mimeType,name'
                });
                const mimeType = fileMetadata.result.mimeType;
                const fileName = fileMetadata.result.name;

                const fileContent = await gapi.client.drive.files.get({
                    fileId: id,
                    alt: 'media'
                });
                const data = btoa(String.fromCharCode.apply(null, new Uint8Array(fileContent.body.toArrayBuffer())));

                attachmentsBlobs.push({
                    mimeType: mimeType,
                    filename: fileName,
                    data: data
                });
                sendStatus.textContent = `Anexo '${fileName}' carregado.`;
            } catch (error) {
                console.error(`Erro ao carregar anexo com ID ${id}:`, error);
                sendStatus.textContent = `Erro ao carregar anexo ${id}. Verifique o ID e as permiss√µes no Google Drive.`;
                sendSpinner.classList.add('hidden');
                createAndSendButton.disabled = false;
                return; 
            }
        }

        let sentCount = 0;
        for (let i = 0; i < numToProcess; i++) {
            const finalSubject = `${subject} ${i + 1}`;
            const rawEmail = createEmail(recipients.join(','), finalSubject, body, attachmentsBlobs);

            try {
                await gapi.client.gmail.users.messages.send({
                    'userId': 'me',
                    'resource': {
                        'raw': base64urlEncode(rawEmail)
                    }
                });
                sentCount++;
                sendStatus.textContent = `Enviado: ${finalSubject} para ${recipients.join(', ')} (${sentCount}/${numToProcess})`;
                await new Promise(resolve => setTimeout(resolve, 500)); 
            } catch (error) {
                console.error(`Erro ao enviar e-mail ${finalSubject}:`, error);
                sendStatus.textContent = `Erro ao enviar e-mail: ${finalSubject}. Verifique o console para mais detalhes.`;
                break; 
            }
        }

        sendSpinner.classList.add('hidden');
        createAndSendButton.disabled = false;
        sendStatus.textContent = `Conclu√≠do! ${sentCount} e-mail(s) enviado(s).`;
        if (sentCount < numToProcess) {
            sendStatus.textContent += ` Houve erros em ${numToProcess - sentCount} e-mails.`;
        }
    }


    // Event Listeners
    nextButton.addEventListener('click', () => {
        if (currentStep < steps.length - 1) {
            currentStep++;
        } else {
            currentStep = 0; // Restart
        }
        showStep(currentStep);
    });

    prevButton.addEventListener('click', () => {
        if (currentStep > 0) {
            currentStep--;
            showStep(currentStep);
        }
    });

    authorizeButton.addEventListener('click', handleAuthClick);
    createAndSendButton.addEventListener('click', createAndSendEmails);
    resetAppButton.addEventListener('click', () => {
        sessionStorage.clear(); 
        recipientInput.value = '';
        subjectInput.value = 'Relat√≥rio Di√°rio';
        bodyInput.value = 'Ol√°! Este √© o seu relat√≥rio di√°rio. Tenha um √≥timo dia!';
        attachmentIdsInput.value = '';
        numDraftsToCreateSendInput.value = 1;
        sendStatus.textContent = '';
        currentStep = 0;
        showStep(currentStep);
        if (auth2 && auth2.isSignedIn.get()) {
            auth2.signOut();
        }
    });

    // Save config on input change
    [recipientInput, subjectInput, bodyInput, attachmentIdsInput].forEach(input => {
        input.addEventListener('input', saveConfig);
    });

    // Initial load
    window.onload = handleClientLoad;
    showStep(currentStep); 
</script>

</body>
</html>
